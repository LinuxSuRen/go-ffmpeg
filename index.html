<h1>Audio file format convert base on ffmpeg</h1>

<input id="fileupload" type="file" name="fileupload" />

<label for="format">Choose a format:</label>
<select name="format" id="format">
    <option value="mp3">mp3</option>
    <option value="wav">wav</option>
    <option value="mp4">mp4</option>
    <option value="mkv">mkv</option>
</select>

<button id="upload-button" onclick="uploadFile()"> Convert </button>

<div id="download">
    <span id="status"></span>
</div>

<script>
    async function uploadFile() {
        let format = document.getElementById("format").value;
        let formData = new FormData();
        formData.append("file", fileupload.files[0]);
        formData.append("format", format)
        const resp = await fetch('/upload', {
            method: "POST",
            body: formData
        });
        const text = await resp.text();
        queryTask(text);
    }

    function queryTask(id) {
        fetch('/queryTask?id='+id)
            .then(res => res.json())
            .then(out => {
                if(out.Output && out.Output!=="") {
                    document.getElementById('status').innerText = 'finished'

                    let but = document.createElement('button')
                    but.innerText = 'Download ' + out.TargetFile
                    but.onclick = function () {
                        window.location = '/download?file=' + out.TargetFile
                    }
                    document.getElementById('download').append(but)
                } else {
                    document.getElementById('status').innerText = 'downloading'
                    window.setTimeout(queryTask, 2000, id)
                }
            })
    }
</script>
